<div *ngIf="entities$ | async as entities">
  <ng-container
    *ngIf="entities.length > 0; then entityList; else noEntities"
  ></ng-container>

  <ng-template #noEntities>
    <br />
    <app-alert type="info">
      Wechseln Sie zu einer Seite in Alma, um eine Liste von Entitäten
      anzuzeigen.
    </app-alert>
  </ng-template>

  <ng-template #entityList>
    <br />

    <button
      mat-flat-button
      color="primary"
      (click)="clear()"
      [disabled]="!selectedEntity"
      style="display: block"
    >
      Zurücksetzen
    </button>

    <br />
    <mat-divider></mat-divider>
    <br />

    <h2>
      <label id="entities-radio-group-label">Wählen Sie eine Entität:</label>
    </h2>

    <mat-radio-group
      aria-labelledby="entities-radio-group-label"
      [(ngModel)]="selectedEntity"
      (change)="onEntitySelected($event)"
    >
      <div *ngFor="let entity of entities" class="entity__list">
        <mat-radio-button
          [value]="entity"
          *ngIf="entity.link.startsWith('/acq/po-lines')"
        >
          {{ entity.description }}
        </mat-radio-button>
      </div>

      <app-alert type="info" *ngIf="!isEntityCorrect">
        Keine Entität enthält die korrekten Daten. Bitte navigieren Sie zur
        entsprechenden Seite
      </app-alert>
    </mat-radio-group>

    <div *ngIf="selectedEntity && !loading">
      <br />
      <mat-divider></mat-divider>
      <br />

      <ng-container
        *ngIf="
          apiResult &&
            apiResult.interested_user &&
            apiResult.interested_user.length > 0;
          then tabGroup;
          else noUserFound
        "
      ></ng-container>

      <ng-template #tabGroup>
        <mat-tab-group animationDuration="0ms">
          <mat-tab label="Benutzer">
            <app-interested-users [users]="apiResult.interested_user">
              <button
                mat-flat-button
                color="primary"
                (click)="saveUsersOrder()"
                [disabled]="loading"
              >
                Speichern
              </button>
            </app-interested-users></mat-tab
          >

          <mat-tab
            label="Ringumlauf"
            *ngIf="
              apiResult.fifth_reporting_code &&
              apiResult.fifth_reporting_code === 'RING'
            "
          >
            <app-ringumlauf [apiResult]="apiResult"></app-ringumlauf>
          </mat-tab>

          <mat-tab
            label="Sternumlauf"
            *ngIf="
              apiResult.fifth_reporting_code &&
              apiResult.fifth_reporting_code === 'STERN'
            "
            ><app-sternumlauf [apiResult]="apiResult"></app-sternumlauf
          ></mat-tab>
        </mat-tab-group>
      </ng-template>

      <ng-template #noUserFound>
        <app-alert type="info"
          >Keine Entität gefunden. Bitte navigieren Sie zur entsprechenden
          Seite</app-alert
        >
      </ng-template>
    </div>
  </ng-template>
</div>

<app-loading-spinner *ngIf="loading"></app-loading-spinner>
